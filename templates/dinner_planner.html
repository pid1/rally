<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rally â€” Dinner Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“°</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <h1>Rally</h1>
        <div class="subtitle">Dinner Planner</div>
    </header>

    <nav>
        <a href="/dashboard">Dashboard</a>
        <a href="/todo">Tasks</a>
        <a href="/dinner-planner" class="active">Dinner Planner</a>
    </nav>

    <div class="section-container">
        <div class="header-container">
            <h2>Dinner Planner</h2>
            <div class="header-actions">
                <button class="btn-add" id="btn-add-dinner">Add Dinner</button>
            </div>
        </div>
        <div class="list-container" id="plans-list">
            <div class="container-loading-state">Loading dinner plans...</div>
        </div>
    </div>

    <!-- Modal for add/edit -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Add Dinner Plan</h3>
            <form id="plan-form">
                <input type="hidden" id="plan-edit-id">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="plan-date" required>
                </div>
                <div class="form-group">
                    <label>Meal Plan</label>
                    <textarea id="plan-text" placeholder="What's for dinner?" required rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Who's Eating? <small>(leave unchecked for everyone)</small></label>
                    <div class="checkbox-group" id="attendee-checkboxes">
                        <!-- Populated from /api/family -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Who's Cooking? <small>(optional)</small></label>
                    <select id="plan-cook">
                        <option value="">â€” nobody assigned â€”</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Save</button>
                    <button type="button" class="btn-cancel" id="btn-cancel">Cancel</button>
                    <button type="button" class="btn-delete modal-delete" id="btn-delete-plan" style="display:none" onclick="confirmDeleteFromModal()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // State
        let plans = [];
        let familyMembers = [];
        let editingId = null;

        // Get date N days from now
        function getDateInDays(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        // Format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const planDate = new Date(date);
            planDate.setHours(0, 0, 0, 0);

            if (planDate.getTime() === today.getTime()) return 'Tonight';
            if (planDate.getTime() === tomorrow.getTime()) return 'Tomorrow';

            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        // Family member helpers
        async function fetchFamilyMembers() {
            const response = await fetch('/api/family');
            familyMembers = await response.json();
            populateFamilyControls();
        }

        function getMemberById(id) {
            return familyMembers.find(m => m.id === id);
        }

        function populateFamilyControls() {
            // Attendee checkboxes
            const checkboxGroup = document.getElementById('attendee-checkboxes');
            checkboxGroup.innerHTML = familyMembers.map(m =>
                `<label class="checkbox-label"><input type="checkbox" class="attendee-cb" value="${m.id}"> ${escapeHtml(m.name)}</label>`
            ).join('');

            // Cook dropdown
            const cookSelect = document.getElementById('plan-cook');
            cookSelect.innerHTML = '<option value="">â€” nobody assigned â€”</option>';
            familyMembers.forEach(m => {
                cookSelect.innerHTML += `<option value="${m.id}">${escapeHtml(m.name)}</option>`;
            });
        }

        function getSelectedAttendeeIds() {
            const checked = document.querySelectorAll('.attendee-cb:checked');
            const ids = Array.from(checked).map(cb => parseInt(cb.value));
            return ids.length > 0 ? ids : null;  // null = everyone
        }

        function getSelectedCookId() {
            const val = document.getElementById('plan-cook').value;
            return val ? parseInt(val) : null;
        }

        // API calls
        async function fetchPlans() {
            const response = await fetch('/api/dinner-plans');
            const allPlans = await response.json();

            // Filter to next 7 days
            const today = new Date().toISOString().split('T')[0];
            const weekFromNow = getDateInDays(7);
            plans = allPlans.filter(p => p.date >= today && p.date <= weekFromNow);

            renderPlans();
        }

        async function savePlan(data) {
            const response = await fetch('/api/dinner-plans', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Failed to save plan');
            return response.json();
        }

        async function updatePlan(id, data) {
            const response = await fetch(`/api/dinner-plans/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Failed to update plan');
            return response.json();
        }

        async function deletePlan(id) {
            const response = await fetch(`/api/dinner-plans/${id}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Failed to delete plan');
        }

        // Render
        function renderPlans() {
            const container = document.getElementById('plans-list');

            if (plans.length === 0) {
                container.innerHTML = '<div class="container-empty-state">No dinner plans for the next 7 days. Click "Add Dinner" to get started.</div>';
                return;
            }

            container.innerHTML = plans.map(plan => {
                // Build meta parts
                const parts = [];
                if (plan.attendee_ids && plan.attendee_ids.length > 0) {
                    const names = plan.attendee_ids.map(id => getMemberById(id)?.name || '?').join(', ');
                    parts.push(`Eating: ${escapeHtml(names)}`);
                }
                if (plan.cook_id) {
                    const cook = getMemberById(plan.cook_id);
                    if (cook) parts.push(`Cook: ${escapeHtml(cook.name)}`);
                }
                const metaHtml = parts.length > 0
                    ? `<div class="editable-item-description">${parts.join(' Â· ')}</div>` : '';

                return `
                    <div class="editable-item" data-id="${plan.id}">
                        <div class="editable-item-content">
                            <div class="editable-item-title">${escapeHtml(plan.plan)}</div>
                            ${metaHtml}
                            <div class="plan-date">${escapeHtml(formatDate(plan.date))}</div>
                        </div>
                        <div class="editable-item-actions">
                            <button class="btn-edit" onclick="openEditModal(${plan.id})">Edit</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal
        function openAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Add Dinner Plan';
            document.getElementById('plan-form').reset();
            document.getElementById('plan-edit-id').value = '';
            document.getElementById('plan-date').value = new Date().toISOString().split('T')[0];
            document.querySelectorAll('.attendee-cb').forEach(cb => cb.checked = false);
            document.getElementById('plan-cook').value = '';
            document.getElementById('btn-delete-plan').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function openEditModal(id) {
            const plan = plans.find(p => p.id === id);
            if (!plan) return;

            editingId = id;
            document.getElementById('modal-title').textContent = 'Edit Dinner Plan';
            document.getElementById('plan-edit-id').value = id;
            document.getElementById('plan-date').value = plan.date;
            document.getElementById('plan-text').value = plan.plan;

            // Set attendee checkboxes
            document.querySelectorAll('.attendee-cb').forEach(cb => {
                cb.checked = plan.attendee_ids && plan.attendee_ids.includes(parseInt(cb.value));
            });

            // Set cook dropdown
            document.getElementById('plan-cook').value = plan.cook_id || '';

            document.getElementById('btn-delete-plan').style.display = '';
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            editingId = null;
        }

        async function confirmDelete(id) {
            if (!confirm('Are you sure you want to delete this dinner plan?')) return;

            try {
                await deletePlan(id);
                await fetchPlans();
            } catch (error) {
                console.error('Error deleting plan:', error);
                alert('Failed to delete dinner plan');
            }
        }

        async function confirmDeleteFromModal() {
            if (!editingId) return;
            if (!confirm('Are you sure you want to delete this dinner plan?')) return;
            try {
                await deletePlan(editingId);
                closeModal();
                await fetchPlans();
            } catch (error) {
                console.error('Error deleting plan:', error);
                alert('Failed to delete dinner plan');
            }
        }

        // Event handlers
        document.getElementById('btn-add-dinner').addEventListener('click', openAddModal);
        document.getElementById('btn-cancel').addEventListener('click', closeModal);
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') closeModal();
        });

        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const date = document.getElementById('plan-date').value;
            const plan = document.getElementById('plan-text').value;
            const attendee_ids = getSelectedAttendeeIds();
            const cook_id = getSelectedCookId();

            try {
                if (editingId) {
                    await updatePlan(editingId, { date, plan, attendee_ids, cook_id });
                } else {
                    await savePlan({ date, plan, attendee_ids, cook_id });
                }
                closeModal();
                await fetchPlans();
            } catch (error) {
                console.error('Error saving plan:', error);
                alert('Failed to save dinner plan');
            }
        });

        // Initialize
        fetchFamilyMembers();
        fetchPlans();
    </script>

    <footer>
        <a href="/settings">Settings</a>
    </footer>
</body>
</html>
